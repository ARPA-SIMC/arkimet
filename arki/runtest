#!/bin/sh -e

TOP_SRCDIR=`pwd`/`dirname $0`/..

CMD=`pwd`/"$1"

## Set up the test environment

export ARKI_SCAN_GRIB1=$TOP_SRCDIR/conf/scan-grib1/
export ARKI_SCAN_GRIB2=$TOP_SRCDIR/conf/scan-grib2/
export ARKI_SCAN_BUFR=$TOP_SRCDIR/conf/scan-bufr/
export ARKI_FORMATTER=$TOP_SRCDIR/conf/format/
export ARKI_REPORT=$TOP_SRCDIR/conf/report/
export ARKI_BBOX=$TOP_SRCDIR/conf/bbox/
export ARKI_QMACRO=$TOP_SRCDIR/conf/qmacro/
export ARKI_TARGETFILE=$TOP_SRCDIR/conf/targetfile/
export ARKI_ALIASES=$TOP_SRCDIR/conf/match-alias.conf
export ARKI_POSTPROC=./postproc
ulimit -v 1048576 || true

ORIGDIR=`pwd`
if which mktemp > /dev/null
then
	TESTDIR="`mktemp -d`"
else
	TESTDIR="/tmp/arkitest.$$"
	mkdir $TESTDIR
fi

cd "$TESTDIR"


mkdir inbound
# Put data in test inbound area
cp -a "$TOP_SRCDIR/test/data/"* inbound/
cp -a "$TOP_SRCDIR/test/postproc" ./
cp -a "$TOP_SRCDIR/test/misc" ./
cp -a "$TOP_SRCDIR/doc/lua-examples" ./
# Create test dataset directories
mkdir test200
mkdir test80
mkdir error
#cp "$TOP_SRCDIR/ept/tests/testdata/"* .
#mv vocabulary test.voc
#mv package-tags test.tag
#mkdir empty

## Clean up the test environment at exit unless asked otherwise
cleanup() {
	test -z "$PRESERVE" && cd $ORIGDIR && rm -rf "$TESTDIR"
}
trap cleanup EXIT

## Run the tests

#id=`date +%y%m%d%H%M%S`
#$DEBUGGER $BIN $ARGS 2>&1 | tee `pwd`/testrun-$id
#echo Output saved in `pwd`/testrun-$id

# Try to debug the libtool executable, if present
DIR=`dirname $CMD`
BASE=`basename $CMD`
if [ ! -z "$DEBUGGER" ] && [ -x $DIR/.libs/lt-$BASE ]
then
	echo "Running $DEBUGGER $DIR/.libs/lt-$BASE $ARGS"
	RES=0
	if ! $DEBUGGER $DIR/.libs/lt-$BASE $ARGS
	then
		RES=$?
		echo "Failed with result $RES"
	fi
else
	echo "Running $DEBUGGER $CMD $ARGS"
	RES=0
	if !  $DEBUGGER $CMD $ARGS
	then
		RES=$?
		echo "Failed with result $RES"
	fi
fi


if [ ! -z "$PAUSE" ]
then
	echo "Post-test inspection requested."
	echo "Exit this shell to cleanup the test environment."
	bash
fi

exit $RES
