--- Matching products

local sample = arki.metadata.new()

-- GRIB1
-- Syntax: product:GRIB1,origin,table,product
-- Any of origin, table, product can be omitted; if omitted, any value
-- will match

sample:set(arki_product.grib1(98, 0, 12))

ensure_matches(sample, "product:GRIB1")
ensure_matches(sample, "product:GRIB1,98")
ensure_matches(sample, "product:GRIB1,98,,12")

ensure_not_matches(sample, "product:GRIB2")
ensure_not_matches(sample, "product:GRIB1,200")
ensure_not_matches(sample, "product:GRIB1,98,0,11")

-- GRIB2
-- Syntax: product:GRIB2,centre,discipline,category,number
-- Any of centre, discipline, category or number can be omitted; if omitted,
-- any value will match

sample:set(arki_product.grib2(98, 0, 1, 2))

ensure_matches(sample, "product:GRIB2")
ensure_matches(sample, "product:GRIB2,98")
ensure_matches(sample, "product:GRIB2,98,,,2")

ensure_not_matches(sample, "product:GRIB1")
ensure_not_matches(sample, "product:GRIB2,200")
ensure_not_matches(sample, "product:GRIB2,98,1,,2")

-- BUFR
-- Syntax: product:BUFR,category,subcategory,subcategory_local:rep_memo
-- Any of category, subcategory, subcategory_local or rep_memo
-- can be omitted; if omitted, any value will match
-- category: data category (BUFR or CREX Table A)
-- subcategory: data subcategory (see Common Code table C-13)
-- subcategory_local: data subcategory local (defined by ADP centres)

sample:set(arki_product.bufr(0, 255, 1, {t="synop"}))

ensure_matches(sample, "product:BUFR")
ensure_matches(sample, "product:BUFR,0,,1")
ensure_matches(sample, "product:BUFR,0,,1:t=synop")
ensure_matches(sample, "product:BUFR:t=synop")

ensure_not_matches(sample, "product:GRIB1")
ensure_not_matches(sample, "product:BUFR:t=temp")

-- ODIMH5
-- Syntax: product:ODIMH5,<OBJ value>,<PROD value>
-- OdimH5 product, identified by object and product values
-- object and product values can be omitted

sample:set(arki_product.odimh5("PVOL","SCAN"))

ensure_matches(sample, "product:ODIMH5")
ensure_matches(sample, "product:ODIMH5,PVOL")
ensure_matches(sample, "product:ODIMH5,,SCAN")

ensure_not_matches(sample, "product:GRIB1")
ensure_not_matches(sample, "product:BUFR:t=temp")

-- VM2
-- Syntax: product:VM2,id:key1=value1,key2=value2,...
-- The keys (key1=value1,...) are loaded at runtime
-- from a meteo-vm2 attribute table.

-- Assume that product with id 23 has the following attributes:
-- {bcode="B22043",tr=254,p1=0,p2=0,lt1=1}
sample:set(arki_product.vm2(23))

ensure_matches(sample, "product:VM2")
ensure_matches(sample, "product:VM2,23")
ensure_matches(sample, "product:VM2,23:bcode=B22043")

ensure_not_matches(sample, "product:GRIB1")
ensure_not_matches(sample, "product:BUFR:t=temp")
ensure_not_matches(sample, "product:VM2,12")
ensure_not_matches(sample, "product:VM2,23:foo=bar")
ensure_not_matches(sample, "product:VM2:foo=bar")
